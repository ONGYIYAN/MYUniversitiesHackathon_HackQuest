<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" />

  <title>Trustify</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>
</head>

<body>
  <div
    class="relative flex size-full min-h-screen flex-col bg-[#FFFFFF] justify-between group/design-root overflow-x-hidden"
    style="font-family: 'Plus Jakarta Sans', 'Noto Sans', sans-serif">
    <div>
      <div class="flex items-center bg-[#FFFFFF] p-4 pb-2 justify-between">
        <!-- Back Button -->
        <div class="text-[#1C160C] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px"
          data-weight="regular">
          <a href="StoreInformation.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
              </path>
            </svg>
          </a>
        </div>
        <h2 class="text-[#1C160C] text-lg font-bold leading-tight tracking-[-0.015em] flex-1">
          Business Profile
        </h2>
      </div>

      <!-- Business Owner Name -->
      <div class="flex p-4 @container">
        <div class="flex w-full flex-col gap-4 @[520px]:flex-row @[520px]:justify-between @[520px]:items-center">
          <div class="flex gap-4">
            <div class="flex-shrink-0">
              <img id="storeImage" class="w-32 h-32 bg-center bg-no-repeat bg-cover rounded-xl" alt="Store Image" />
            </div>

            <div class="flex flex-col justify-center">
              <p class="text-[#1C160C] text-[18px] font-normal leading-tight tracking-[-0.015em];">
                Wallet Address
              </p>
              <!-- Wallet Address -->
              <p class="text-[#1C160C] text-[22px] font-normal leading-tight tracking-[-0.015em]" id="wallet-address">
                Wallet Address:
                <span id="wallet-address-value" style="font-size: 12.5px"></span>
              </p>
              <!-- Rating with Star Icon -->
              <div class="flex items-center mt-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor"
                  class="text-[#A18249]" viewBox="0 0 256 256">
                  <path
                    d="M128,18a10,10,0,0,1,9,5l29,59,65,10a10,10,0,0,1,5,17l-47,46,11,64a10,10,0,0,1-14,10l-58-30-58,30a10,10,0,0,1-14-10l11-64-47-46a10,10,0,0,1,5-17l65-10,29-59A10,10,0,0,1,128,18Z">
                  </path>
                </svg>
                <p id="owner-rating" class="text-[#A18249] text-sm font-normal leading-normal ml-1">
                  5.0 (n Reviews)
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Section -->
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">
            Business Name
          </p>
          <p id="businessName" class="text-[#A18249] text-base font-medium leading-normal"></p>
        </label>
      </div>

      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">
            Location
          </p>
          <p id="businessLocation" class="text-[#A18249] text-base font-medium leading-normal"></p>
        </label>
      </div>

      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">
            Contact Number
          </p>
          <p id="contact-no" class="text-[#A18249] text-base font-medium leading-normal"></p>
        </label>
      </div>

      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">
            Business Registration Number (BRN)
          </p>
          <p id="reg-no" class="text-[#A18249] text-base font-medium leading-normal"></p>
        </label>
      </div>

      <!-- Code Generation Section -->
      <div class="flex flex-col gap-4 px-4 py-3">
        <label class="flex flex-col">
          <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">
            Issue Verification Code:
          </p>
          <input id="customerAddressInput" placeholder="Customer Wallet Address"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#1C160C] focus:outline-0 focus:ring-0 border border-[#E9DFCE] bg-[#FFFFFF] focus:border-[#E9DFCE] h-14 placeholder:text-[#A18249] p-[15px] text-base font-normal leading-normal"
            value="" />
        </label>
        <div class="flex justify-end">
          <button id="issueCodeButton"
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-[#F4EFE6] text-[#1C160C] text-base font-bold leading-normal tracking-[0.015em]">
            <span class="truncate">Issue Code</span>
          </button>
        </div>
      </div>

      <!-- Reviews -->
      <h3
        class="text-[#1C160C] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4 flex justify-between items-center">
        Recent Reviews
        <div class="text-[#1C160C] flex items-center justify-center cursor-pointer"
          onclick="window.location.href='StoreInformation.html'">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
            <path
              d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z">
            </path>
          </svg>
        </div>
      </h3>

      <div id="reviewsContainer">
      </div>

      <!-- Log out -->
      <div>
        <div class="flex px-4 py-3 justify-center">
          <button onclick="window.location.href='index.html'"
            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 flex-1 bg-opacity-70 bg-[#F4EFE6] text-[#1C160C] text-base font-bold leading-normal tracking-[0.015em] border border-[#E9DFCE]">
            <span class="truncate">Log Out</span>
          </button>
        </div>
        <div class="h-5 bg-[#FFFFFF]"></div>
      </div>
    </div>
  </div>
  <script>
    async function init() {
      await window.ethereum.request({ method: "eth_requestAccounts" });
      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const contractAddress = "0xb0d498Cd2D0EDE81c5857fd38837f3F5409FE385";
      const abi = [
        "function issueVerificationCode(address customer) public",
        "function getOwnerDetails(address user) public view returns (string memory name, string memory location, string memory contactNumber, string memory registrationNo, string memory ipfsHash)",
        "function getAverageRating(address owner) public view returns (uint256)",
        "function ownerReviewsCount(address owner) public view returns (uint256)", // Assuming this function exists
        "event VerificationCodeIssued(address indexed owner, address indexed customer, string code)",
        "function getOwnerReviews(address owner) public view returns (tuple(address userAddress, uint256 rating, string description, uint256 timestamp)[] memory)"
      ];

      contract = new ethers.Contract(contractAddress, abi, signer);

      const ownerAddress = await signer.getAddress(); // Get the current wallet address
      const truncatedAddress = `${ownerAddress.slice(0, 6)}...${ownerAddress.slice(-4)}`;
      // Display the wallet address on the page
      document.getElementById("wallet-address").textContent = truncatedAddress;

      await getOwnerDetails(ownerAddress);
      await getOwnerRatingAndReviews(ownerAddress); // Fetch ratings and reviews
      await fetchReviews(ownerAddress);
    }

    // Fetch owner details like name, location, contact
    async function getOwnerDetails(ownerAddress) {
      try {
        const [name, location, contactNumber, registrationNo, ipfsHash] =
          await contract.getOwnerDetails(ownerAddress);
        document.getElementById("businessName").textContent = `${name}`;
        document.getElementById("businessLocation").textContent = `${location}`;
        document.getElementById("contact-no").textContent = `${contactNumber}`;
        document.getElementById("reg-no").textContent = `${registrationNo}`;
        const ipfsGateway = "https://gateway.pinata.cloud/ipfs/";
        document.getElementById("storeImage").src = ipfsGateway + ipfsHash;
      } catch (error) {
        console.error("Error fetching owner details:", error);
      }
    }

    // Fetch average rating and number of reviews
    async function getOwnerRatingAndReviews(ownerAddress) {
      try {
        // Fetch average rating
        const averageRating = await contract.getAverageRating(ownerAddress);
        const formattedRating = (Number(averageRating) / 10).toFixed(1);

        // Fetch review count
        const reviewCount = await contract.ownerReviewsCount(ownerAddress);

        // Update the UI
        const ratingElement = document.getElementById("owner-rating");
        if (ratingElement) {
          ratingElement.textContent = `${formattedRating} (${reviewCount} Reviews)`;
        } else {
          console.warn("Rating element not found in the DOM");
        }
      } catch (error) {
        console.error("Error fetching rating and reviews:", error);

        // Update UI to show error state
        const ratingElement = document.getElementById("owner-rating");
        if (ratingElement) {
          ratingElement.textContent = "N/A (Error fetching data)";
        }
      }
    }

    document.getElementById("issueCodeButton").onclick = async () => {
      try {
        const customerAddress = document.getElementById("customerAddressInput").value;
        const tx = await contract.issueVerificationCode(customerAddress);
        await tx.wait();
        alert("Verification code issued successfully!");
        document.getElementById("customerAddressInput").value = "";
      } catch (error) {
        console.error("Issue Code Error:", error);
      } finally {
        // Re-enable the button and reset its text
        document.getElementById("issueCodeButton").disabled = false;
        document.getElementById("issueCodeButton").textContent = "Issue Code";
      }
    };

    // Function to generate star ratings
    function generateStars(rating) {
      const starsContainer = document.getElementById('stars');
      starsContainer.innerHTML = ''; // Clear any existing stars

      for (let i = 1; i <= 5; i++) {
        const star = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        star.setAttribute("class", "star"); // Add base class

        // Determine the star type based on the rating
        if (i <= Math.floor(rating)) {
          star.classList.add("filled"); // Full star
        } else if (i === Math.ceil(rating) && rating % 1 !== 0) {
          star.classList.add("half"); // Half star if rating has a decimal
        }

        // Create the star shape
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", "M12 .587l3.668 7.431 8.165 1.182-5.917 5.769 1.396 8.141L12 18.896l-7.312 3.84 1.396-8.141-5.917-5.769 8.165-1.182z");
        star.appendChild(path);
        starsContainer.appendChild(star);
      }
    }

    // Function to format the timestamp to "17 October 2024, 2:30 PM"
    function formatDate(timestamp) {
      // Check if the timestamp is in seconds (10 digits) and convert to milliseconds if necessary
      if (String(timestamp).length === 10) {
        timestamp = timestamp * 1000; // Convert seconds to milliseconds
      }

      const date = new Date(timestamp);

      // Define month names for manual formatting
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      // Extract the day, month, and year
      const day = date.getDate(); // Day of the month
      const month = monthNames[date.getMonth()]; // Month name
      const year = date.getFullYear(); // Year
      const hours = date.getHours(); // Hours
      const minutes = date.getMinutes(); // Minutes

      // Format hours to 12-hour format and determine AM/PM
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const formattedHours = hours % 12 || 12; // Convert to 12-hour format
      const formattedMinutes = minutes < 10 ? '0' + minutes : minutes; // Add leading zero if needed

      // Construct the formatted date string
      return `${day} ${month} ${year}, ${formattedHours}:${formattedMinutes} ${ampm}`;
    }

    async function fetchReviews(ownerAddress) {
      try {
        const reviews = await contract.getOwnerReviews(ownerAddress);
        console.log("Fetched reviews:", reviews);

        // Check if reviews are indeed in the expected format
        if (!Array.isArray(reviews)) {
          console.warn("Reviews is not an array");
          return;
        }

        // Map through Proxy objects and extract review details
        const formattedReviews = reviews.map((review) => {
          return {
            reviewer: review[0],      // Extract user address
            rating: Number(review[1]), // Extract rating, converting BigInt to Number
            description: review[2],      // Extract description
            reviewTime: Number(review[3]) // Extract timestamp, converting BigInt to Number
          };
        });

        displayReviews(formattedReviews);
      } catch (error) {
        console.error("Error fetching reviews:", error);
      }
    }

    function displayReviews(reviews) {
      const reviewsContainer = document.getElementById("reviewsContainer");
      reviewsContainer.innerHTML = ""; // Clear previous reviews

      // Sort reviews by timestamp in descending order
      reviews.sort((a, b) => b.reviewTime - a.reviewTime); // b.reviewTime for descending order

      // Check if there are reviews
      if (reviews.length === 0) {
        const noReviewsMessage = document.createElement("p");
        noReviewsMessage.className = "flex flex-col bg-[#F9F9F9] px-6 py-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 text-[#0b161e] text-base font-medium leading-normal text-center pr-4"; // Align right with padding
        noReviewsMessage.textContent = "No reviews available.";
        reviewsContainer.appendChild(noReviewsMessage);
        return; // Exit the function since there are no reviews
      }

      // Create and append review cards
      reviews.forEach(review => {
        const reviewCard = document.createElement("div");
        reviewCard.className = "flex items-start bg-[#F9F9F9] px-6 py-6 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300"; // Changed flex-col to flex and added items-start

        // Profile Photo
        const avatar = document.createElement("div");
        avatar.className = "bg-center bg-no-repeat aspect-square bg-cover rounded-full h-20 w-20";
        avatar.style.backgroundImage = `url("https://img.freepik.com/premium-photo/round-user-icon-isolated-white-background-3d-rendering_499459-408.jpg")`; // Update to user avatar URL if available

        const reviewContent = document.createElement("div");
        reviewContent.className = "flex flex-col justify-center flex-grow ml-4"; // Added left margin to separate from avatar

        // Customer's Wallet Address
        const userName = document.createElement("p");
        userName.className = "text-[#1C160C] text-lg font-semibold leading-tight line-clamp-1";
        userName.textContent = review.reviewer.length > 10 ? `${review.reviewer.slice(0, 5)}...${review.reviewer.slice(-3)}` : review.reviewer;// Access the reviewer address correctly // Access the reviewer address correctly
        userName.style.fontSize = "0.85em";

        // Star Rating
        const starRating = document.createElement("div");
        starRating.className = "flex gap-0.5 mt-1";

        for (let i = 0; i < review.rating; i++) {
          const star = document.createElement("div");
          star.className = "text-[#1f93e0]";
          star.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" class="text-[#A18249]" viewBox="0 0 256 256">
      <path d="M128,18a10,10,0,0,1,9,5l29,59,65,10a10,10,0,0,1,5,17l-47,46,11,64a10,10,0,0,1-14,10l-58-30-58,30a10,10,0,0,1-14-10l11-64-47-46a10,10,0,0,1,5-17l65-10,29-59A10,10,0,0,1,128,18Z"></path>
    </svg>`;
          starRating.appendChild(star);
        }

        // Customer Review
        const reviewComment = document.createElement("p");
        reviewComment.className = "text-[#1C160C] text-sm font-normal leading-tight mt-3 line-clamp-2";
        reviewComment.textContent = review.description;

        // Review Date
        const reviewDate = document.createElement("p");
        reviewDate.className = "text-[#A18249] text-xs font-normal leading-tight mt-3";
        const timestamp = Number(review.reviewTime); // Ensure it's a number
        reviewDate.textContent = formatDate(timestamp); // Pass the number directly

        // Append elements to the content container
        reviewContent.appendChild(userName);
        reviewContent.appendChild(starRating);
        reviewContent.appendChild(reviewComment);
        reviewContent.appendChild(reviewDate);

        // Append avatar and content to the card
        reviewCard.appendChild(avatar);
        reviewCard.appendChild(reviewContent);

        // Append card to the container
        reviewsContainer.appendChild(reviewCard);
      });

    }

    window.onload = init;
  </script>
</body>

</html>
