<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" />

  <title>Trustify</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>
  <style>
    .redeem-button:disabled {
      background-color: #d3d3d3;
      /* Lighter grey for a softer look */
      border: 1px solid #a0a0a0;
      /* A border to give it definition */
      cursor: not-allowed;
      color: #ffffff;
      /* White text for contrast */
      opacity: 0.7;
      /* Slight transparency for a more elegant effect */
    }

    .redeem-button:disabled:hover {
      background-color: #d3d3d3;
      /* Keep the same background on hover */
      opacity: 0.6;
      /* Darken slightly on hover for feedback */
    }
  </style>
</head>

<body>
  <div
    class="relative flex size-full min-h-screen flex-col bg-[#FFFFFF] justify-between group/design-root overflow-x-hidden"
    style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
    <div class="flex items-center bg-[#FFFFFF] p-4 pb-2 justify-between">
      <!-- Back Button -->
      <div class="text-[#1C160C] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px"
        data-weight="regular">
        <a href="ProfileCust.html">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
            <path
              d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
            </path>
          </svg>
        </a>
      </div>
      <h2 class="text-[#1C160C] text-lg font-bold leading-tight tracking-[-0.015em] flex-1">Redeem Voucher</h2>
      <div class="flex w-12 items-center justify-end">

        <!-- Profile -->
        <div class="flex items-center text-[#A18249] font-normal leading-tight" style="font-size: 12px;">
          <p>TOKENS:&nbsp;</p>
          <span id="customer-points">0</span>
        </div>
      </div>
    </div>

    <!-- Voucher 1 -->
    <div class="bg-cover bg-center flex items-center rounded-xl p-4 shadow-lg m-4 relative h-32"
      style='background-image: url("https://cdn.usegalileo.ai/sdxl10/dfc556b0-95a9-43ac-b451-72e92434d0d2.png");'>
      <div class="flex flex-col justify-between h-full text-white flex-grow">
        <p class="text-4xl font-bold leading-tight">RM1</p>
        <p class="text-xs font-medium">*Valid for 3 months</p>
      </div>
      <!-- Right side box for Required Tokens and Redeem button -->
      <div class="absolute right-0 flex items-center h-full w-[150px] bg-[#A18249] border-l border-white rounded-r-xl">
        <div class="flex flex-col items-center w-full justify-center">
          <span class="text-white text-sm mb-2">10 Tokens</span> <!-- Add margin-bottom to Required Tokens -->
          <button data-voucher="1"
            class="redeem-button flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#F4EFE6] text-[#1C160C] text-sm font-bold leading-normal tracking-[0.015em]">
            <span class="truncate">Redeem</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Voucher 2 -->
    <div class="bg-cover bg-center flex items-center rounded-xl p-4 shadow-lg m-4 relative h-32"
      style='background-image: url("https://cdn.usegalileo.ai/sdxl10/dfc556b0-95a9-43ac-b451-72e92434d0d2.png");'>
      <div class="flex flex-col justify-between h-full text-white flex-grow">
        <p class="text-4xl font-bold leading-tight">RM3</p>
        <p class="text-xs font-medium">*Valid for 3 months</p>
      </div>
      <!-- Right side box for Required Tokens and Redeem button -->
      <div class="absolute right-0 flex items-center h-full w-[150px] bg-[#A18249] border-l border-white rounded-r-xl">
        <div class="flex flex-col items-center w-full justify-center">
          <span class="text-white text-sm mb-2">28 Tokens</span> <!-- Add margin-bottom to Required Tokens -->
          <button data-voucher="2"
            class="redeem-button flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#F4EFE6] text-[#1C160C] text-sm font-bold leading-normal tracking-[0.015em]">
            <span class="truncate">Redeem</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Voucher 3 -->
    <div class="bg-cover bg-center flex items-center rounded-xl p-4 shadow-lg m-4 relative h-32"
      style='background-image: url("https://cdn.usegalileo.ai/sdxl10/dfc556b0-95a9-43ac-b451-72e92434d0d2.png");'>
      <div class="flex flex-col justify-between h-full text-white flex-grow">
        <p class="text-4xl font-bold leading-tight">RM5</p>
        <p class="text-xs font-medium">*Valid for 3 months</p>
      </div>
      <!-- Right side box for Required Tokens and Redeem button -->
      <div class="absolute right-0 flex items-center h-full w-[150px] bg-[#A18249] border-l border-white rounded-r-xl">
        <div class="flex flex-col items-center w-full justify-center">
          <span class="text-white text-sm mb-2">46 Tokens</span> <!-- Add margin-bottom to Required Tokens -->
          <button data-voucher="3"
            class="redeem-button flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#F4EFE6] text-[#1C160C] text-sm font-bold leading-normal tracking-[0.015em]">
            <span class="truncate">Redeem</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Voucher 4 -->
    <div class="bg-cover bg-center flex items-center rounded-xl p-4 shadow-lg m-4 relative h-32"
      style='background-image: url("https://cdn.usegalileo.ai/sdxl10/dfc556b0-95a9-43ac-b451-72e92434d0d2.png");'>
      <div class="flex flex-col justify-between h-full text-white flex-grow">
        <p class="text-4xl font-bold leading-tight">RM10</p>
        <p class="text-xs font-medium">*Valid for 3 months</p>
      </div>
      <!-- Right side box for Required Tokens and Redeem button -->
      <div class="absolute right-0 flex items-center h-full w-[150px] bg-[#A18249] border-l border-white rounded-r-xl">
        <div class="flex flex-col items-center w-full justify-center">
          <span class="text-white text-sm mb-2">92 Tokens</span> <!-- Add margin-bottom to Required Tokens -->
          <button data-voucher="4"
            class="redeem-button flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#F4EFE6] text-[#1C160C] text-sm font-bold leading-normal tracking-[0.015em]">
            <span class="truncate">Redeem</span>
          </button>
        </div>
      </div>
    </div>

    <div class="h-5 bg-white"></div>

    <script>
      let provider, signer, contract;
      const contractAddress = '0x49c173aa408180FD93039E44084B6C00B169436C'; // Replace with your contract address
      const abi = [
        "function getCustomerPoints(address customer) public view returns (uint256)",
        "function redeemVoucher(uint256 voucherType) public",
        "function getRedeemedVouchers() public view returns (tuple(string code, uint256 voucherType, uint256 redeemedAt)[])",
        "event VoucherRedeemed(address indexed customer, string voucherCode, uint256 pointsUsed, uint256 voucherType)"
      ];

      async function init() {
        if (window.ethereum) {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();

          // Set up contract instance
          contract = new ethers.Contract(contractAddress, abi, signer);

          // Display token balance
          await displayCustomerPoints();

          // Set up redeem buttons
          setupRedeemButtons();
        } else {
          alert("Please install MetaMask to use this feature.");
        }
      }

      const voucherRequirements = {
        1: 10,   // Tokens needed for Voucher 1
        2: 28,   // Tokens needed for Voucher 2
        3: 46,   // Tokens needed for Voucher 3
        4: 92    // Tokens needed for Voucher 4
      };

      async function displayCustomerPoints() {
        try {
          const walletAddress = await signer.getAddress();
          const points = await contract.getCustomerPoints(walletAddress);
          document.getElementById("customer-points").innerText = points;

          // Check points and enable/disable buttons accordingly
          const buttons = document.querySelectorAll(".redeem-button");
          buttons.forEach((button) => {
            const voucherType = button.getAttribute("data-voucher");
            const requiredTokens = voucherRequirements[voucherType];

            if (points < requiredTokens) {
              button.disabled = true;  // Disable the button if not enough tokens
            } else {
              button.disabled = false; // Enable if enough tokens
            }
          });

        } catch (error) {
          console.error("Error fetching customer points:", error);
          alert("Failed to fetch customer points. Please try again.");
        }
      }

      function setupRedeemButtons() {
        const buttons = document.querySelectorAll(".redeem-button");
        buttons.forEach((button) => {
          button.addEventListener("click", async () => {
            const voucherType = button.getAttribute("data-voucher");
            await redeemVoucher(voucherType);
          });
        });
      }

      async function redeemVoucher(type) {
        try {
          const tx = await contract.redeemVoucher(type);
          alert(`Transaction sent! Waiting for confirmation...`);

          const receipt = await tx.wait();
          const voucherRedeemedEvent = receipt.logs.find(
            log => log.topics[0] === ethers.id("VoucherRedeemed(address,string,uint256,uint256)")
          );

          if (voucherRedeemedEvent) {
            const decodedLog = contract.interface.parseLog(voucherRedeemedEvent);
            const pointsUsed = decodedLog.args.pointsUsed;
            alert(`Voucher successfully redeemed!\nPoints used: ${pointsUsed}\nPlease check your profile for the voucher details.`);

            // Refresh customer points after redemption
            await displayCustomerPoints();

            // Optionally, redirect to ProfileCust.html to show updated voucher list
            window.location.href = `ProfileCust.html`;
          } else {
            alert("Voucher redeemed, but couldn't retrieve the voucher code. Please check your transaction history.");
          }

        } catch (error) {
          console.error("Error redeeming voucher:", error);
          alert("Error redeeming voucher. Please try again.");
        }
      }

      window.onload = init;
    </script>
</body>

</html>
