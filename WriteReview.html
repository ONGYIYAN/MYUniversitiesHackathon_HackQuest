<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" />

  <title>Trustify</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>

  <style>
    /* Basic star styles */
    .star {
      font-size: 2rem;
      cursor: pointer;
      color: #ccc;
    }

    /* Lit stars will have a different color */
    .star.lit {
      color: #ffc107;
    }
  </style>
</head>

<body>
  <div
    class="relative flex size-full min-h-screen flex-col bg-[#FFFFFF] justify-between group/design-root overflow-x-hidden"
    style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>

    <div>
      <div class="flex items-center bg-[#FFFFFF] p-4 pb-2 justify-between">
        <!-- Back Button -->
        <div class="text-[#1C160C] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px"
          data-weight="regular">
          <a href="ProfileCust.html">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
              </path>
            </svg>
          </a>
        </div>
        <h2 class="text-[#1C160C] text-lg font-bold leading-tight tracking-[-0.015em] flex-1">Rate This Business</h2>
        <div class="flex w-12 items-center justify-end">
          <button onclick="window.location.href='ProfileCust.html'"
            class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 bg-transparent text-[#1C160C] gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0">
            <div class="text-[#1C160C]" data-icon="UserCircle" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                viewBox="0 0 256 256">
                <path
                  d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM74.08,197.5a64,64,0,0,1,107.84,0,87.83,87.83,0,0,1-107.84,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.76,66.41a79.66,79.66,0,0,0-36.06-28.75,48,48,0,1,0-59.4,0,79.66,79.66,0,0,0-36.06,28.75,88,88,0,1,1,131.52,0Z">
                </path>
              </svg>
            </div>
          </button>
        </div>
      </div>

      <div id="businessDetails" class="flex items-center p-4">
        <div class="flex-shrink-0">
          <div class="flex-shrink-0">
            <img id="storeImage" class="w-32 h-32 bg-center bg-no-repeat bg-cover rounded-xl" alt="Store Image" />
          </div>
        </div>
        <div class="flex-1 bg-[#FFFFFF] p-4 text-left pl-8">
          <p id="businessName" class="text-[#1C160C] text-lg font-bold leading-normal">Placeholder Store Name</p>
          <p id="businessLocation" class="text-[#A18249] text-base font-normal">Placeholder Store Location</p>
          <p id="contactNumber" class="text-[#A18249] text-base font-normal">Placeholder Contact Number</p>
        </div>
      </div>

      <h2 class="text-[#181411] tracking-light text-[28px] font-bold leading-tight px-4 text-left pt-5">How was your
        experience?</h2>
      <p class="text-[#181411] text-base font-normal leading-normal pb-3 pt-1 px-4">
        Your feedback helps others make better decisions. Reviews are public and reflect the opinion of the writer.
      </p>

      <div class="flex flex-col bg-white px-4 py-3 justify-between">
        <div class="flex flex-1 flex-col justify-center">
          <p class="text-[#181411] text-base font-medium leading-normal">How would you rate this place?</p>
          <div id="rating-stars" class="flex items-center gap-2">
            <!-- Star Rating Layout (with unique IDs) -->
            <span class="star" id="star1" onclick="setRating(1)">&#9733;</span>
            <span class="star" id="star2" onclick="setRating(2)">&#9733;</span>
            <span class="star" id="star3" onclick="setRating(3)">&#9733;</span>
            <span class="star" id="star4" onclick="setRating(4)">&#9733;</span>
            <span class="star" id="star5" onclick="setRating(5)">&#9733;</span>
          </div>
          <p id="current-rating" class="text-[#897461] text-sm font-normal leading-normal">Selected rating: 0 stars</p>
        </div>
      </div>

      <div class="flex max-w-[480px] flex-col gap-4 px-4 py-3">
        <label class="flex flex-col">
          <p class="text-[#181411] text-base font-medium leading-normal pb-2">Review</p>
          <textarea id="description" placeholder="Write a review"
            class="form-input flex w-full resize-none overflow-hidden rounded-xl text-[#181411] focus:outline-0 focus:ring-0 border-none bg-[#f5f5f5] focus:border-none min-h-36 placeholder:text-[#897461] p-4 text-base font-normal leading-normal"></textarea>
        </label>

        <button id="submitReviewButton"
          class="cursor-pointer items-center justify-center rounded-full h-12 w-full bg-[#F4EFE6] text-[#1C160C] text-base font-bold leading-normal tracking-[0.015em]">
          <span class="truncate">Submit</span>
        </button>
      </div>

      <div class="h-5 bg-white"></div>
    </div>

    <script>
      let userRegistration;
      let ownerWithCode = null;
      let selectedRating = 0; // Default rating is 0
      let verificationCode;
      async function init() {
        const urlParams = new URLSearchParams(window.location.search);
        verificationCode = urlParams.get('code'); // Get verification code from URL

        // Now you can use the verification code in your contract calls
        console.log("Verification Code:", verificationCode);

        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();

        const contractAddress = "xf1096B67D436e664ddC837368760d043A392A078";
        const abi = [
          "function getVerificationCode(address owner) public view returns (string memory)",
          "function getOwnerDetails(address user) public view returns (string memory name, string memory location, string memory contactNumber, string memory registrationNo, string memory ipfsHash)",
          "function getAllRegisteredOwners() public view returns (address[] memory)",
          "function leaveReview(address ownerAddress, uint256 rating, string memory description) public",
          "event ReviewSubmitted(address indexed customerAddress, address indexed ownerAddress, uint256 rating, string description, uint256 timestamp)"
        ];
        userRegistration = new ethers.Contract(contractAddress, abi, signer);

        // Call a function to display owner details using the verification code if needed
        if (verificationCode) {
          await displayOwnerDetails(verificationCode);
        } else {
          console.log("No verification code found in URL.");
        }
      }

      async function displayOwnerDetails(verificationCode) {
        // You may want to modify this function to find the owner based on the verification code
        // For example, using the code to fetch details
        try {
          const provider = new ethers.BrowserProvider(window.ethereum);
          const signer = await provider.getSigner();
          const address = await signer.getAddress();

          console.log("Current user address:", address);

          const owners = await userRegistration.getAllRegisteredOwners();
          console.log("All registered owners:", owners);

          // Loop through all owners to find the one with the matching verification code
          for (const owner of owners) {
            const code = await userRegistration.getVerificationCode(owner);
            console.log("Comparing code:", code.toString(), "with verificationCode:", verificationCode); // Convert code to string for comparison
            if (code.toString() === verificationCode) {
              ownerWithCode = owner;
              break;
            }
          }

          if (ownerWithCode) {
            const ownerDetails = await userRegistration.getOwnerDetails(ownerWithCode);
            const [name, location, contactNumber, registrationNo, ipfsHash] = ownerDetails;

            // Update the UI with owner details
            document.getElementById("businessName").innerText = name;
            document.getElementById("businessLocation").innerText = location; // Assuming you want to display location too
            document.getElementById("contactNumber").innerText = contactNumber;

            // Display the store image from IPFS
            const ipfsGateway = "https://gateway.pinata.cloud/ipfs/";
            document.getElementById("storeImage").src = ipfsGateway + ipfsHash;
          } else {
            document.getElementById("businessName").innerText = "No owner found for this verification code.";
          }
        } catch (error) {
          console.error("Error in displayOwnerDetails:", error);
          document.getElementById("businessName").innerText = "Error retrieving owner details";
        }
      }

      // Function to light up the stars based on the selected rating
      function setRating(rating) {
        selectedRating = rating;
        document.getElementById("current-rating").textContent = `Selected rating: ${rating} stars`;

        // Loop through all stars and light them up based on the rating
        for (let i = 1; i <= 5; i++) {
          const star = document.getElementById(`star${i}`);
          if (i <= rating) {
            star.classList.add('lit');  // Add 'lit' class to light up the star
          } else {
            star.classList.remove('lit');  // Remove 'lit' class to unlight the star
          }
        }
      }


      document.getElementById("submitReviewButton").onclick = async () => {
        try {
          const rating = selectedRating;
          const description = document.getElementById("description").value;

          if (rating < 0 || rating > 5) {
            alert("Rating must be between 0 and 5.");
            return;
          }

          if (!description) {
            alert("Please enter a description.");
            return;
          }

          if (!ownerWithCode) {
            alert("No owner with a valid verification code found. Cannot submit review.");
            return;
          }

          console.log("Submitting review for owner:", ownerWithCode);
          console.log("Rating:", rating);
          console.log("Description:", description);

          const tx = await userRegistration.leaveReview(ownerWithCode, rating, description);
          await tx.wait();

          console.log("Review submitted successfully. Transaction:", tx.hash);
          alert("Review submitted successfully!");

          // Redirect to the profile page after successful submission
          window.location.href = `StoreInformation.html?ownerAddress=${ownerWithCode}`;
        } catch (error) {
          console.error("Error submitting review:", error);

          if (error.code === 4001) {
            // MetaMask transaction rejection (user clicked cancel)
            alert("Rating canceled. You rejected the MetaMask transaction.");
          } else if (error.code === 'ACTION_REJECTED') {
            // ethers.js error related to transaction rejection
            alert("Rating canceled due to MetaMask action rejection.");
          } else {
            // Handle other errors
            alert("There was an error submitting your review: " + error.message);
          }
        }
      };

      window.onload = init;
    </script>
  </div>
</body>

</html>
