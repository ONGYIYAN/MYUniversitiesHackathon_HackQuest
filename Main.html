<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" />

  <title>Trustify</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>
</head>

<body>
  <!-- <div
    class="relative flex size-full min-h-screen flex-col bg-[#FFFFFF] justify-between group/design-root overflow-x-hidden"
    style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
    <div> -->
  <div class="flex items-center bg-[#FFFFFF] p-4 pb-2 justify-between">
    <!-- Simplified Logout Icon Button -->
    <div class="flex items-center">
      <button class="flex items-center cursor-pointer text-[#1C160C] bg-transparent hover:bg-[#F4EFE6] rounded-full p-2"
        onclick="window.location.href='index.html';">
        <svg xmlns="http://www.w3.org/2000/svg" width="22px" height="22px" fill="currentColor" viewBox="0 0 24 24">
          <path d="M10 2v2h8v16h-8v2h10v-20h-10zm-1 5l-7 5 7 5v-4h9v-2h-9v-4z" />
        </svg>
      </button>
    </div>

    <!-- Back Button -->
    <!-- <button
      class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 bg-transparent text-[#1C160C] gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0"> -->
    <div class="text-[#1C160C] flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px"
      data-weight="regular">
      <!-- <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
          <path
            d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
          </path>
        </svg> -->
    </div>
    <!-- </button> -->
    <div class="flex w-12 items-center justify-end">
      <!-- Profile -->
      <button id="profileButton"
        class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 bg-transparent text-[#1C160C] gap-2 text-base font-bold leading-normal tracking-[0.015em] min-w-0 p-0"
        onclick="redirectToProfile()"> <!-- Call the redirect function on click -->
        <div class="text-[#1C160C]" data-icon="UserCircle" data-size="24px" data-weight="regular">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
            <path
              d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM74.08,197.5a64,64,0,0,1,107.84,0,87.83,87.83,0,0,1-107.84,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.76,66.41a79.66,79.66,0,0,0-36.06-28.75,48,48,0,1,0-59.4,0,79.66,79.66,0,0,0-36.06,28.75,88,88,0,1,1,131.52,0Z">
            </path>
          </svg>
        </div>
      </button>
    </div>
  </div>
  </div>
  <div>
    <div class="px-4 py-3">
      <label class="flex flex-col min-w-40 h-12 w-full">
        <!-- Search -->
        <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
          <button
            class="text-[#A18249] flex border-none bg-[#F4EFE6] items-center justify-center pl-4 rounded-l-xl border-r-0"
            data-icon="MagnifyingGlass" data-size="24px" data-weight="regular" onclick="filterOwners()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z">
              </path>
            </svg>
          </button>
          <input id="storeSearch"="Search Store"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#1C160C] focus:outline-0 focus:ring-0 border-none bg-[#F4EFE6] focus:border-none h-full placeholder:text-[#A18249] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
            value="" onkeypress="checkEnter(event)" />
        </div>
      </label>
    </div>
    <!-- Map Image -->
    <!-- <div class="flex px-4 py-3">
        <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl object-cover"
          style='background-image: url("https://cdn.usegalileo.ai/maps/60465309-b2d0-4f86-ad75-5690e0b770ac.png");'>
        </div>
      </div> -->
    <div class="px-4 py-3">
      <label class="flex flex-col min-w-40 h-12 w-full">
        <!-- Location -->
        <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
          <button
            class="text-[#A18249] flex border-none bg-transparent items-center justify-center pl-4 rounded-l-xl border-r-0"
            data-icon="Location" data-size="24px" data-weight="regular" onclick="filterOwners()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M128,16A96,96,0,0,0,32,112c0,52.27,92,140,92,140s92-87.73,92-140A96,96,0,0,0,128,16Zm0,132a36,36,0,1,1,36-36A36,36,0,0,1,128,148Z">
              </path>
            </svg>
          </button>
          <input id="addressSearch" placeholder="Enter address"
            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#1C160C] focus:outline-0 focus:ring-0 border-none bg-transparent focus:border-none h-full placeholder:text-[#A18249] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
            value="" onkeypress="checkEnter(event)" />
        </div>
      </label>
    </div>

    <div class="flex items-center gap-4 bg-[#FFFFFF] px-4 min-h-[72px] py-2 justify-between">
      <div id="ownerList"> <!-- Set margin-top to 0 here -->
      </div>
    </div>

    <script>
      function checkEnter(event) {
        // Check if the pressed key is Enter (key code 13)
        if (event.key === 'Enter') {
          filterOwners(); // Call the filter function
        }
      }
      // Function to get the user role from local storage
      function getUserRole() {
        return localStorage.getItem('userRole');
      }

      // Function to redirect users to their profile page based on their role
      function redirectToProfile() {
        const userRole = getUserRole(); // Retrieve the user's role

        if (userRole === 'customer') {
          window.location.href = 'ProfileCust.html'; // Redirect to customer profile
        } else if (userRole === 'businessOwner') {
          window.location.href = 'ProfileBusiness.html'; // Redirect to business owner profile
        } else {
          console.error('Unknown user role:', userRole);
          // Optionally handle unknown role if necessary
        }
      }

      // This function can be called after the user logs in
      function loginUser(role) {
        localStorage.setItem('userRole', role); // Set the user role
        // Add other login logic as needed
        redirectToProfile(); // Redirect after login
      }

      // Example login function
      function handleLogin() {
        // Check if the user is already logged in
        if (!getUserRole()) {
          // Simulate a login (you can replace this with your actual login logic)
          const userRole = 'customer'; // or 'businessOwner'
          loginUser(userRole); // Call the loginUser function with the role
          // Redirect to main page or refresh to update the UI
          window.location.reload();
        } else {
          redirectToProfile(); // Redirect to profile if already logged in
        }
      }

      // Call handleLogin to simulate login when the page loads (for testing)
      window.onload = handleLogin;

      // Function to initialize the connection and fetch registered owners
      async function init() {
        // Request account access
        await window.ethereum.request({ method: "eth_requestAccounts" });

        // Connect to the Ethereum provider
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();

        // Define the contract details
        const contractAddress = "0x9d63F9bEd315aCD96B5a4e5284FBDCa131262c22";
        const abi = [
          "function getAllRegisteredOwners() public view returns (address[])",
          "function getOwnerDetails(address user) public view returns (string memory name, string memory location, string memory contactNumber, string memory registrationNo, string memory ipfsHash)",
          "function getAverageRating(address owner) public view returns (uint256)",
          "function ownerReviewsCount(address owner) public view returns (uint256)"
        ];

        // Create a contract instance
        const contract = new ethers.Contract(contractAddress, abi, signer);

        // Call the function from the smart contract to get all registered owners
        try {
          const owners = await contract.getAllRegisteredOwners();
          console.log("Registered Owners:", owners);
          ownersData = [];
          // Loop through owner addresses and pass them to display their details
          owners.forEach(async (ownerAddress) => {
            await displayOwnerDetails(contract, ownerAddress);
          });
        } catch (error) {
          console.error("Error fetching owners:", error);
        }
      }

      // Function to fetch and display details for each owner
      async function displayOwnerDetails(contract, ownerAddress) {
        try {
          // Fetch owner details from the smart contract
          const ownerDetails = await contract.getOwnerDetails(ownerAddress);
          const averageRating = await contract.getAverageRating(ownerAddress);
          const formattedRating = (Number(averageRating) / 10).toFixed(1);
          const reviewCount = await contract.ownerReviewsCount(ownerAddress);
          const [name, location, contactNumber, registrationNo, ipfsHash] = ownerDetails;
          ownersData.push({
            address: ownerAddress,
            name: name || "Unknown",
            location: location || "Unknown",
            rating: formattedRating,
            reviewCount: reviewCount || 0,
            imageUrl: ipfsHash ? `https://gateway.pinata.cloud/ipfs/${ipfsHash}` : 'https://cdn.usegalileo.ai/sdxl10/c2f039c9-7e92-4f4e-a7a5-92b7de482dc9.png'
          });

          // Get the container to display the owners
          const ownerList = document.getElementById('ownerList');
          ownerList.style.marginTop = '-11px';

          // Create the outer div with the "flex items-center justify-between" class
          const ownerDiv = document.createElement('div');
          ownerDiv.classList.add('flex', 'items-center', 'gap-4', 'bg-[#FFFFFF]', 'px-4', 'min-h-[72px]', 'py-2', 'justify-between', 'w-screen'); // Added 'w-screen' for full viewport width

          // Create the container for image and details (to group them on the left)
          const leftDiv = document.createElement('div');
          leftDiv.classList.add('flex', 'items-center', 'gap-4');

          // Create the div for the store image
          const imageDiv = document.createElement('div');
          imageDiv.classList.add('bg-center', 'bg-no-repeat', 'aspect-square', 'bg-cover', 'rounded-lg', 'size-14');

          // Check if ipfsHash is available and set the background image accordingly
          const ipfsGateway = "https://gateway.pinata.cloud/ipfs/";
          const imageUrl = ipfsHash ? `${ipfsGateway}${ipfsHash}` : 'https://cdn.usegalileo.ai/sdxl10/c2f039c9-7e92-4f4e-a7a5-92b7de482dc9.png';
          imageDiv.style.backgroundImage = `url('${imageUrl}')`;

          // Create the container for the text (owner's details)
          const detailsDiv = document.createElement('div');
          detailsDiv.classList.add('flex', 'flex-col', 'justify-center', 'flex-grow'); // Add 'flex-grow' to push button to the right

          // Create and add the owner's name
          const nameP = document.createElement('p');
          nameP.classList.add('text-[#1C160C]', 'text-base', 'font-medium', 'leading-normal', 'line-clamp-1');
          nameP.textContent = name;

          // Create the rating section
          const ratingDiv = document.createElement('div');
          ratingDiv.classList.add('flex', 'items-center', 'mt-1');
          ratingDiv.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" class="text-[#A18249]" viewBox="0 0 256 256">
      <path d="M128,18a10,10,0,0,1,9,5l29,59,65,10a10,10,0,0,1,5,17l-47,46,11,64a10,10,0,0,1-14,10l-58-30-58,30a10,10,0,0,1-14-10l11-64-47-46a10,10,0,0,1,5-17l65-10,29-59A10,10,0,0,1,128,18Z"></path>
  </svg>`;
          const ratingP = document.createElement('p');
          ratingP.classList.add('text-[#A18249]', 'text-sm', 'font-medium', 'leading-normal', 'ml-1');
          ratingP.textContent = formattedRating;
          const reviewP = document.createElement('p');
          reviewP.classList.add('text-[#A18249]', 'text-sm', 'font-normal', 'leading-normal', 'ml-1');
          reviewP.textContent = `(${reviewCount} Reviews)`;

          // Create the location section
          const locationDiv = document.createElement('div');
          locationDiv.classList.add('flex', 'items-center', 'mt-1');
          locationDiv.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" class="text-[#A18249]" viewBox="0 0 256 256">
      <path d="M128,16A96,96,0,0,0,32,112c0,52.27,92,140,92,140s92-87.73,92-140A96,96,0,0,0,128,16Zm0,132a36,36,0,1,1,36-36A36,36,0,0,1,128,148Z"></path>
  </svg>
  <p class="text-[#A18249] text-sm font-normal leading-normal ml-1">${location}</p>`;

          // Append name, rating, and location to the details div
          detailsDiv.appendChild(nameP);
          detailsDiv.appendChild(ratingDiv);
          ratingDiv.appendChild(ratingP);
          ratingDiv.appendChild(reviewP);
          detailsDiv.appendChild(locationDiv);

          // Append the image and details to the leftDiv
          leftDiv.appendChild(imageDiv);
          leftDiv.appendChild(detailsDiv);

          // Create the container div with 'shrink-0' for the button
          const buttonContainer = document.createElement('div');
          buttonContainer.classList.add('shrink-0');

          // Create the button with the arrow icon
          const button = document.createElement('button');
          button.classList.add('text-[#1C160C]', 'text-base', 'font-normal', 'leading-normal', 'bg-transparent', 'px-4', 'py-2', 'rounded-lg', 'hover:bg-[#e0d8c7]', 'flex', 'items-center', 'gap-2', 'mr-4'); // Added 'mr-2' to move the button slightly left

          // Add SVG icon inside the button
          button.innerHTML = `
  <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
      <path d="M173.66,122.34,125.66,74.34a8,8,0,1,0-11.32,11.32L151.34,128l-37,37a8,8,0,1,0,11.32,11.32l48-48a8,8,0,0,0,0-11.32Z"></path>
  </svg>`;

          // Add click event listener to the button
          button.addEventListener('click', () => {
            // Redirect to the store information page with ownerAddress as a query parameter
            window.location.href = `StoreInformation.html?ownerAddress=${ownerAddress}`;
          });

          // Append the button to the container div
          buttonContainer.appendChild(button);

          // Append the left div (image + details) and the button container to the main owner div
          ownerDiv.appendChild(leftDiv);  // Image and details on the left
          ownerDiv.appendChild(buttonContainer);  // Button on the right

          // Append the owner div to the ownerList element
          ownerList.appendChild(ownerDiv);


        } catch (error) {
          console.error("Error fetching owner details:", error);
        }
      }

      function filterOwners() {
        const storeSearchValue = document.getElementById('storeSearch').value.toLowerCase();
        const addressSearchValue = document.getElementById('addressSearch').value.toLowerCase();

        const filteredOwners = ownersData.filter(owner => {
          const matchesStoreName = storeSearchValue && owner.name.toLowerCase().includes(storeSearchValue);
          const matchesAddress = addressSearchValue && owner.location.toLowerCase().includes(addressSearchValue);

          return matchesStoreName || matchesAddress; // Show if either matches
        });

        displayOwners(filteredOwners); // Display filtered owners
        if (filteredOwners.length > 0) {
        } else {
          alert('No owners found matching your search criteria.');
        }
      }

      // Add a function to display the filtered owners (if not already present)
      function displayOwners(owners) {
        const ownerList = document.getElementById('ownerList');
        ownerList.innerHTML = ''; // Clear the list before displaying filtered results
        ownerList.style.marginTop = '-27px';

        owners.forEach(owner => {
          // Create the outer div with the "flex items-center" class
          const ownerDiv = document.createElement('div');
          ownerDiv.classList.add('flex', 'items-center', 'gap-4', 'bg-[#FFFFFF]', 'px-4', 'min-h-[72px]', 'py-2', 'justify-between', 'w-screen', 'mt-4'); // Added 'w-screen' for full width

          // Create the div for the store image
          const imageDiv = document.createElement('div');
          imageDiv.classList.add('bg-center', 'bg-no-repeat', 'aspect-square', 'bg-cover', 'rounded-lg', 'size-14');

          // Use imageUrl from the owner object directly
          imageDiv.style.backgroundImage = `url('${owner.imageUrl}')`;

          // Create the container for the text (owner's details)
          const detailsDiv = document.createElement('div');
          detailsDiv.classList.add('flex', 'flex-col', 'justify-center', 'flex-grow'); // Add 'flex-grow' to push button to the right

          // Create and add the owner's name
          const nameP = document.createElement('p');
          nameP.classList.add('text-[#1C160C]', 'text-base', 'font-medium', 'leading-normal', 'line-clamp-1');
          nameP.textContent = owner.name;

          // Create the rating section
          const ratingDiv = document.createElement('div');
          ratingDiv.classList.add('flex', 'items-center', 'mt-1');
          ratingDiv.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" class="text-[#A18249]" viewBox="0 0 256 256">
        <path d="M128,18a10,10,0,0,1,9,5l29,59,65,10a10,10,0,0,1,5,17l-47,46,11,64a10,10,0,0,1-14,10l-58-30-58,30a10,10,0,0,1-14-10l11-64-47-46a10,10,0,0,1,5-17l65-10,29-59A10,10,0,0,1,128,18Z"></path>
      </svg>`;
          const ratingP = document.createElement('p');
          ratingP.classList.add('text-[#A18249]', 'text-sm', 'font-medium', 'leading-normal', 'ml-1');
          ratingP.textContent = owner.rating;
          const reviewP = document.createElement('p');
          reviewP.classList.add('text-[#A18249]', 'text-sm', 'font-normal', 'leading-normal', 'ml-1');
          reviewP.textContent = `(${owner.reviewCount} Reviews)`; // Replace with actual reviews count

          // Create the location section
          const locationDiv = document.createElement('div');
          locationDiv.classList.add('flex', 'items-center', 'mt-1');
          locationDiv.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" class="text-[#A18249]" viewBox="0 0 256 256">
        <path d="M128,16A96,96,0,0,0,32,112c0,52.27,92,140,92,140s92-87.73,92-140A96,96,0,0,0,128,16Zm0,132a36,36,0,1,1,36-36A36,36,0,0,1,128,148Z"></path>
      </svg>
      <p class="text-[#A18249] text-sm font-normal leading-normal ml-1">${owner.location}</p>
    `;

          // Append name, rating, and location to the details div
          detailsDiv.appendChild(nameP);
          detailsDiv.appendChild(ratingDiv);
          ratingDiv.appendChild(ratingP);
          ratingDiv.appendChild(reviewP);
          detailsDiv.appendChild(locationDiv);

          // Create the button with the arrow icon
          const buttonDiv = document.createElement('div');
          buttonDiv.classList.add('shrink-0', 'ml-auto'); // Ensure button does not shrink
          const button = document.createElement('button');
          button.classList.add('text-[#1C160C]', 'text-base', 'font-normal', 'leading-normal', 'bg-transparent', 'px-4', 'py-2', 'rounded-lg', 'hover:bg-[#e0d8c7]', 'flex', 'items-center', 'gap-2', 'mr-4');

          // Add SVG icon inside the button
          button.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
        <path d="M173.66,122.34,125.66,74.34a8,8,0,1,0-11.32,11.32L151.34,128l-37,37a8,8,0,1,0,11.32,11.32l48-48a8,8,0,0,0,0-11.32Z"></path>
      </svg>`;

          // Add the click event listener to redirect to store information page
          button.addEventListener('click', () => {
            // Redirect to the store information page with ownerAddress as a query parameter
            window.location.href = `StoreInformation.html?ownerAddress=${owner.address}`;
          });

          // Append the button to the buttonDiv
          buttonDiv.appendChild(button);

          // Append the image, details, and button div to the main owner div
          ownerDiv.appendChild(imageDiv);
          ownerDiv.appendChild(detailsDiv);
          ownerDiv.appendChild(buttonDiv);

          // Append the owner div to the ownerList element
          ownerList.appendChild(ownerDiv);
        });
      }
      // Call the init function when the window loads
      window.onload = init;
    </script>

</body>

</html>
