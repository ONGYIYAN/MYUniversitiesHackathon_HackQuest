<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" />
    <title>Trustify</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        /* Add some style for the error message */
        .error {
            color: red;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .message {
            color: red;
            font-size: 1rem;
            margin-top: 0.5rem;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>
</head>

<body>
    <div class="relative flex size-full min-h-screen flex-col bg-[#FFFFFF] justify-between group/design-root overflow-x-hidden"
        style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
        <div>
            <div class="flex items-center bg-[#FFFFFF] p-4 pb-2 justify-between">
                <!-- Back Button -->
                <button onclick="history.back()" class="text-[#1C160C] flex size-12 shrink-0 items-center"
                    data-icon="ArrowLeft" data-size="24px" data-weight="regular">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                        viewBox="0 0 256 256">
                        <path
                            d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
                        </path>
                    </svg>
                </button>
                <h2 class="text-[#1C160C] text-lg font-bold leading-tight tracking-[-0.015em] flex-1">Register As
                    Business Owner
                </h2>
                <div class="flex w-12 items-center justify-end"></div>
            </div>

            <h2 class="text-[#0e161b] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Business
                Information</h2>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                <label class="flex flex-col min-w-40 flex-1">
                    <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">Business Name</p>
                    <input id="businessName" placeholder="e.g. EFG Sdn.Bhd."
                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#1C160C] focus:outline-0 focus:ring-0 border border-[#E9DFCE] bg-[#FFFFFF] focus:border-[#E9DFCE] h-14 placeholder:text-[#A18249] p-[15px] text-base font-normal leading-normal"
                        value="" required />
                    <p id="nameError" class="error"></p>
                </label>
            </div>

            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                <label class="flex flex-col min-w-40 flex-1">
                    <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">Business Location</p>
                    <input id="businessLocation" placeholder="e.g. Johor Bahru, Johor"
                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#1C160C] focus:outline-0 focus:ring-0 border border-[#E9DFCE] bg-[#FFFFFF] focus:border-[#E9DFCE] h-14 placeholder:text-[#A18249] p-[15px] text-base font-normal leading-normal"
                        value="" required />
                    <p id="locationError" class="error"></p>
                </label>
            </div>

            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                <label class="flex flex-col min-w-40 flex-1">
                    <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">Contact Number</p>
                    <input id="businessContNumber" placeholder="e.g. +60123456789"
                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#1C160C] focus:outline-0 focus:ring-0 border border-[#E9DFCE] bg-[#FFFFFF] focus:border-[#E9DFCE] h-14 placeholder:text-[#A18249] p-[15px] text-base font-normal leading-normal"
                        value="" required />
                    <p id="contactNoError" class="error"></p>
                </label>
            </div>

            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
                <label class="flex flex-col min-w-40 flex-1">
                    <p class="text-[#1C160C] text-base font-medium leading-normal pb-2">Business Registration Number
                        (BRN)</p>
                    <input id="businessRegNumber" placeholder="e.g. 201001000000 (12345-A)"
                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#1C160C] focus:outline-0 focus:ring-0 border border-[#E9DFCE] bg-[#FFFFFF] focus:border-[#E9DFCE] h-14 placeholder:text-[#A18249] p-[15px] text-base font-normal leading-normal"
                        value="" required />
                    <p id="brnError" class="error"></p>
                </label>
            </div>

            <h2 class="text-[#0e161b] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Documents
            </h2>
            <div class="flex flex-col px-4 min-h-14">
                <div class="flex items-center gap-4 justify-between">
                    <p class="text-[#0e161b] text-base font-normal leading-normal flex-1 truncate">
                        Upload Business Image
                    </p>
                    <div class="shrink-0">
                        <input type="file" id="storeImage" accept="image/*" class="hidden" />
                        <button onclick="document.getElementById('storeImage').click()"
                            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#F4EFE6] text-[#1C160C] text-sm font-bold leading-normal tracking-[0.015em]">
                            <span class="truncate">Upload</span>
                        </button>
                    </div>
                </div>
                <!-- Error message for certificate upload -->
                <p id="fileError" class="error"></p>
                <p id="fileName" class="text-[#1C160C] text-base font-normal leading-normal"></p>
                <!-- File name display -->
            </div>
            <div class="flex px-4 py-3">
                <button onclick="submitForm()"
                    class="cursor-pointer items-center justify-center rounded-full h-12 w-full bg-[#F4EFE6] text-[#1C160C] text-base font-bold leading-normal tracking-[0.015em]">
                    <span class="truncate">Submit</span>
                </button>
            </div>
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        let ipfsHash;
        let userRegistration;
        let signer;
        const pinataApiKey = '2e24581a4970cecbfab9';
        const pinataSecretApiKey = '009af7a63149cea6d14db28d2cd1fa18c9f80e326c7810f6aec4d17e741b5511';

        async function init() {
            try {
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                const provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                const contractAddress = "0x49c173aa408180FD93039E44084B6C00B169436C";
                const abi = [
                    "function registerOwner(string memory name, string memory location, string memory contactNumber, string memory regNumber, string memory ipfsHash) public",
                    "function isOwnerRegistered(address user) public view returns (bool)",
                    "function getOwnerDetails(address user) public view returns (string memory name, string memory location, string memory contactNumber, string memory regNumber, string memory ipfsHash)",
                    "event UserRegistered(address indexed user, string role)"
                ];

                userRegistration = new ethers.Contract(contractAddress, abi, signer);
            } catch (error) {
                console.error("Initialization Error:", error);
                document.getElementById("message").innerText = "Failed to connect to Ethereum network. Please make sure you have MetaMask installed and connected.";
            }
        }

        async function registerOwner(name, location, contactNumber, regNumber, ipfsHash) {
            try {
                if (!userRegistration || !signer) {
                    throw new Error("Contract or signer not initialized");
                }
                const tx = await userRegistration.registerOwner(name, location, contactNumber, regNumber, ipfsHash);
                localStorage.setItem('userRole', 'businessOwner');
                await tx.wait();
                document.getElementById("message").innerText = "Business Owner registration successful!";
                window.location.href = "StoreInformation.html";
            } catch (error) {
                console.error("Transaction Error:", error);
                document.getElementById("message").innerText = "Failed to register: " + error.message;
            }
        }

        function validateForm() {
            const name = document.getElementById("businessName").value;
            const location = document.getElementById("businessLocation").value;
            const contactno = document.getElementById("businessContNumber").value;
            const regNumber = document.getElementById("businessRegNumber").value;
            let isValid = true;

            if (!name) {
                document.getElementById("nameError").innerText = "Business Name is required";
                isValid = false;
            }

            if (!location) {
                document.getElementById("locationError").innerText = "Business Location is required";
                isValid = false;
            }

            if (!contactno || !/^\+?[0-9]{10,15}$/.test(contactno)) {
                document.getElementById("contactNoError").innerText = "Contact Number is invalid";
                isValid = false;
            }

            if (!regNumber) {
                document.getElementById("brnError").innerText = "Business Registration Number is required";
                isValid = false;
            }

            return isValid;
        }

        async function submitForm() {
            const isValid = validateForm();
            if (isValid) {
                const name = document.getElementById("businessName").value;
                const location = document.getElementById("businessLocation").value;
                const contactno = document.getElementById("businessContNumber").value;
                const regNumber = document.getElementById("businessRegNumber").value;
                if (!ipfsHash) {
                    document.getElementById("fileError").innerText = "Please upload a store image.";
                    return;
                }
                await registerOwner(name, location, contactno, regNumber, ipfsHash);
            }
        }

        document.getElementById('storeImage').addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                uploadToPinata(file);
            }
        });

        async function uploadToPinata(file) {
            const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;

            let formData = new FormData();
            formData.append('file', file);

            const options = {
                method: 'POST',
                headers: {
                    pinata_api_key: pinataApiKey,
                    pinata_secret_api_key: pinataSecretApiKey,
                },
                body: formData
            };

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                ipfsHash = data.IpfsHash;
                document.getElementById("fileName").innerText = file.name;
                document.getElementById("fileError").innerText = ""; // Clear any previous error
            } catch (error) {
                console.error("IPFS Upload Error:", error);
                document.getElementById("fileError").innerText = "Failed to upload file to IPFS.";
            }
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>
